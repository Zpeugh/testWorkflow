/*
 * This build file was auto generated by running the Gradle 'init' task
 * by 'zpeugh' at '5/14/15 12:31 PM' with Gradle 2.4
 *
 * This generated file contains a commented-out sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at http://gradle.org/docs/2.4/userguide/tutorial_java_projects.html
 */

// Apply the java plugin to add support for Java

import org.apache.tools.ant.taskdefs.condition.Os

apply plugin: 'groovy'

repositories{
  mavenCentral()
}

// In this section you declare the dependencies for your production and test code
dependencies {
	compile 'org.codehaus.groovy:groovy-all:2.4.3'
    testCompile 'org.spockframework:spock-core:0.7-groovy-2.0'
}

String flowName

task unzip() {
    doFirst{
        def dir = System.properties['user.home'] + '/Downloads/'
        flowName = System.console().readLine("\nFlow name: ")
        flowName = flowName.replace('.flow', '')
        def fileString = flowName + '.flow'
        def myCopySpec
        def srcDir = "${buildDir}/Resources".replace('build/','')
        def outputDir = file(srcDir)

        copy{
            from {
                println ("Unzipping file: " + dir + fileString)
                zipTree(dir + fileString)
            }
            into {
                println ("Into: " + outputDir)
                outputDir
            }
        }
    }

    doLast{

        def jsonFile = file('Resources/Flow.json')
        jsonFile.renameTo('Resources/' + flowName + '.json' )
        FileTree actions = fileTree(dir: 'Resources/actions')
        FileTree conditions = fileTree(dir: 'Resources/conditions')

        delete actions
        delete conditions
    }
}




task runMain( dependsOn: 'classes', type: JavaExec) {

    doFirst{

        tasks.unzip.execute()
        tasks.cleanResources.execute()

        main = 'flow.WorkFlow'
        classpath = sourceSets.main.runtimeClasspath
        standardInput = System.in
        standardOutput = System.out

        def company = System.console().readLine("\nCompany name: ")



        def arguments = new ArrayList<>()
        arguments << company.replaceAll(' ', '~')
        arguments << flowName + '.json'

        args = arguments
    }

    doLast{
        tasks.showInBrowser.execute()
        tasks.exportWorkflow.execute()
    }
}

task exportWorkflow()  {

    String homeDirectory = System.properties['user.home']
    def folderString = homeDirectory + '/Desktop/ExportToGoogleDrive/'

    doFirst{
        FileTree googleDriveFolder = fileTree(new File(folderString))
        delete googleDriveFolder
    }

    doLast{

        FileTree resources = fileTree(dir: 'Resources')
        FileTree actionImages = fileTree(dir: 'Resources/images')
        FileTree formImages = fileTree(dir: 'Resources/formHtmls/images')

        resources.exclude('.DS_Store')
        resources.exclude('**/*.css')
        resources.exclude('**/*.json')

        resources = resources.minus(actionImages).getAsFileTree()
        resources = resources.minus(formImages).getAsFileTree()

        File arbitraryFile = file(resources[0])
        String absolutePath = arbitraryFile.toString() - relativePath(arbitraryFile)

        File exportsFolder = mkdir(folderString);
        File resourcesFolder = mkdir(exportsFolder.toString() + '/Resources/');
        File actionHtmlsFolder = mkdir(resourcesFolder.toString() + '/actionHtmls/');
        File eventsFolder = mkdir(resourcesFolder.toString() + '/Events/');
        File formHtmlsFolder = mkdir(resourcesFolder.toString() + '/formHtmls/');
        mkdir(actionHtmlsFolder.toString() + '/actionPNGs/');
        mkdir(formHtmlsFolder.toString() + '/formPNGs/');
        mkdir(eventsFolder.toString() + '/texts/');
        def fileString, noColonFileString, extension, myCopySpec
        String baseName

        resources.each{File file ->

            fileString = file.toString()
            extension = file.name.split('\\.')
            baseName = file.name.replaceFirst(~/\.[^\.]+$/, '') + '.' + extension[-1]
            noColonFileString = baseName.replaceAll(':', '[colon]')

            myCopySpec = project.copySpec {
               into folderString

               copy{
                   from fileString
                   into folderString + (fileString - absolutePath) - baseName
                   rename( baseName, noColonFileString )
               }
            }
        }
    }
}


task cleanResources() {

    doFirst{
        FileTree resources = fileTree(dir: 'Resources')
        FileTree images = fileTree(dir: 'Resources/images')

        resources.exclude('.DS_Store')
        resources.exclude('**/*.css')
        resources.exclude('**/*.json')
        resources.exclude('SpidaEmblem.png')
        resources.exclude('formHtmls/images')

        resources = resources.minus(images).getAsFileTree()

        delete resources
        delete 'actions/'
        delete 'conditions/'
    }
}

task showInBrowser() {
    doLast{

        if (Os.isFamily(Os.FAMILY_WINDOWS)) {
            'cmd /c start Resources/Events/eventIndex.html'.execute()
        } else {
            def thisDirectory = System.getProperty("user.dir")
            java.awt.Desktop.desktop.browse( ('File://' + thisDirectory + '/Resources/Events/eventIndex.html').toURI() )
        }
    }
}
